AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  thankshell-api

  Sample SAM Template for thankshell-api
  
Parameters:
 Environment:
   Type: String
   AllowedValues:
   - staging
   - production
   Default: staging

Mappings:
  EnvironmentMap:
    production:
      TransactionDatabase: production
      TableInfo: table_info
      RemittanceTransactions: remittance_transactions
      AuthTable: thankshell_authrozation_prd
      UsersTable: thankshell_users_prd
      GroupsTable: thankshell_groups_prd
    staging:
      TransactionDatabase: develop
      TableInfo: dev_table_info
      RemittanceTransactions: dev_remittance_transactions
      AuthTable: thankshell_authrozation_stg
      UsersTable: thankshell_users_stg
      GroupsTable: thankshell_groups_stg

# More info about Globals: https://github.com/awslabs/serverless-application-model/blob/master/docs/globals.rst
Globals:
  Function:
    Timeout: 3
    Environment:
      Variables:
        AUTH_TABLE_NAME: !FindInMap [ EnvironmentMap, !Ref Environment, AuthTable ]
        USERS_TABLE_NAME: !FindInMap [ EnvironmentMap, !Ref Environment, UsersTable ]
        GROUPS_TABLE_NAME: !FindInMap [ EnvironmentMap, !Ref Environment, GroupsTable ]

Resources:

  ###############################################
  # Api

  ThankshellApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      Auth:
        DefaultAuthorizer: CognitoAuthorizer
        AddDefaultAuthorizerToCorsPreflight: false
        Authorizers:
          CognitoAuthorizer:
            UserPoolArn: arn:aws:cognito-idp:ap-northeast-1:027569216980:userpool/ap-northeast-1_GyRiCriHq
      Variables:
        transaction_database: !FindInMap [ EnvironmentMap, !Ref Environment, TransactionDatabase ]
      Cors:
        AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
        AllowOrigin: "'*'"
      GatewayResponses:
        UNAUTHORIZED:
          StatusCode: 401
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: "'*'"

  ###############################################
  # Database

  AuthTable:
    Type: AWS::Serverless::SimpleTable
    Properties:
        TableName: !FindInMap [ EnvironmentMap, !Ref Environment, AuthTable ]
        PrimaryKey:
            Name: auth_id
            Type: String

  UsersTable:
    Type: AWS::Serverless::SimpleTable
    Properties:
        TableName: !FindInMap [ EnvironmentMap, !Ref Environment, UsersTable ]
        PrimaryKey:
            Name: user_id
            Type: String

  GroupsTable:
    Type: AWS::Serverless::SimpleTable
    Properties:
        TableName: !FindInMap [ EnvironmentMap, !Ref Environment, GroupsTable ]
        PrimaryKey:
            Name: group_id
            Type: String

  ###############################################
  # Layers

  CommonLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: thankshell-libs
      Description: Common Application Resource Layer
      ContentUri: layers

  #######################################
  # Functions

  #
  # User
  #

  GetUserInfo:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: get-user-info/
      Handler: index.handler
      Runtime: nodejs10.x
      Events:
        ApiTrigger:
          Type: Api
          Properties:
            Path: /user
            Method: get
            RestApiId: !Ref ThankshellApi
      Policies:
        - DynamoDBReadPolicy:
            TableName: !FindInMap [ EnvironmentMap, !Ref Environment, AuthTable ]
        - DynamoDBReadPolicy:
            TableName: !FindInMap [ EnvironmentMap, !Ref Environment, UsersTable ]
      Layers:
      - !Ref CommonLayer

  CreateUser:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: create-user/
      Handler: index.handler
      Runtime: nodejs10.x
      Events:
        ApiTrigger:
          Type: Api
          Properties:
            Path: /user
            Method: put
            RestApiId: !Ref ThankshellApi
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !FindInMap [ EnvironmentMap, !Ref Environment, AuthTable ]
        - DynamoDBCrudPolicy:
            TableName: !FindInMap [ EnvironmentMap, !Ref Environment, UsersTable ]
      Layers:
      - !Ref CommonLayer

  #
  # Groups
  #

  GetGroupInfo:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: get-group-info/
      Handler: index.handler
      Runtime: nodejs10.x
      Events:
        ApiTrigger:
          Type: Api
          Properties:
            Path: /groups/{group}
            Method: get
            RestApiId: !Ref ThankshellApi
      Policies:
        - DynamoDBReadPolicy:
            TableName: !FindInMap [ EnvironmentMap, !Ref Environment, AuthTable ]
        - DynamoDBReadPolicy:
            TableName: !FindInMap [ EnvironmentMap, !Ref Environment, UsersTable ]
        - DynamoDBReadPolicy:
            TableName: !FindInMap [ EnvironmentMap, !Ref Environment, GroupsTable ]
      Layers:
      - !Ref CommonLayer

  #
  # Token publiched
  #

  GetTokenPublished:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: get-token-published/
      Handler: index.handler
      Runtime: nodejs10.x
      Events:
        ApiTrigger:
          Type: Api
          Properties:
            Path: /token/{token}/published
            Method: get
            RestApiId: !Ref ThankshellApi
      Policies:
        - DynamoDBReadPolicy:
            TableName: thankshell_user_links
        - DynamoDBReadPolicy:
            TableName: thankshell_users
      Layers:
      - !Ref CommonLayer

  PublishToken:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: publish-token/
      Handler: index.handler
      Runtime: nodejs10.x
      Events:
        ApiTrigger:
          Type: Api
          Properties:
            Path: /token/{token}/published
            Method: post
            RestApiId: !Ref ThankshellApi
      Policies:
        - DynamoDBReadPolicy:
            TableName: !FindInMap [ EnvironmentMap, !Ref Environment, AuthTable ]
        - DynamoDBReadPolicy:
            TableName: !FindInMap [ EnvironmentMap, !Ref Environment, UsersTable ]
        - DynamoDBReadPolicy:
            TableName: !FindInMap [ EnvironmentMap, !Ref Environment, GroupsTable ]
        - DynamoDBCrudPolicy:
            TableName: !FindInMap [ EnvironmentMap, !Ref Environment, TableInfo ]
        - DynamoDBCrudPolicy:
            TableName: !FindInMap [ EnvironmentMap, !Ref Environment, RemittanceTransactions ]
      Layers:
      - !Ref CommonLayer

  #
  # Token Holders
  #

  GetTokenHolders:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: get-token-holders/
      Handler: index.handler
      Runtime: nodejs10.x
      Events:
        ApiTrigger:
          Type: Api
          Properties:
            Path: /token/{token}/holders
            Method: get
            RestApiId: !Ref ThankshellApi
      Policies:
        - DynamoDBReadPolicy:
            TableName: !FindInMap [ EnvironmentMap, !Ref Environment, AuthTable ]
        - DynamoDBReadPolicy:
            TableName: !FindInMap [ EnvironmentMap, !Ref Environment, UsersTable ]
        - DynamoDBReadPolicy:
            TableName: !FindInMap [ EnvironmentMap, !Ref Environment, TableInfo ]
        - DynamoDBReadPolicy:
            TableName: !FindInMap [ EnvironmentMap, !Ref Environment, RemittanceTransactions ]
      Layers:
      - !Ref CommonLayer

  GetTokenHoldings:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: get-token-holdings/
      Handler: index.handler
      Runtime: nodejs10.x
      Events:
        ApiTrigger:
          Type: Api
          Properties:
            Path: /token/{token}/holders/{user}
            Method: get
            RestApiId: !Ref ThankshellApi
      Policies:
        - DynamoDBReadPolicy:
            TableName: !FindInMap [ EnvironmentMap, !Ref Environment, AuthTable ]
        - DynamoDBReadPolicy:
            TableName: !FindInMap [ EnvironmentMap, !Ref Environment, UsersTable ]
        - DynamoDBReadPolicy:
            TableName: !FindInMap [ EnvironmentMap, !Ref Environment, TableInfo ]
        - DynamoDBReadPolicy:
            TableName: !FindInMap [ EnvironmentMap, !Ref Environment, RemittanceTransactions ]
      Layers:
      - !Ref CommonLayer

  #
  # Token Transaction
  #

  GetTransactions:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: get-transactions/
      Handler: index.handler
      Runtime: nodejs10.x
      Events:
        ApiTrigger:
          Type: Api
          Properties:
            Path: /token/{token}/transactions
            Method: get
            RestApiId: !Ref ThankshellApi
      Policies:
        - DynamoDBReadPolicy:
            TableName: !FindInMap [ EnvironmentMap, !Ref Environment, AuthTable ]
        - DynamoDBReadPolicy:
            TableName: !FindInMap [ EnvironmentMap, !Ref Environment, UsersTable ]
        - DynamoDBReadPolicy:
            TableName: !FindInMap [ EnvironmentMap, !Ref Environment, GroupsTable ]
        - DynamoDBReadPolicy:
            TableName: !FindInMap [ EnvironmentMap, !Ref Environment, TableInfo ]
        - DynamoDBReadPolicy:
            TableName: !FindInMap [ EnvironmentMap, !Ref Environment, RemittanceTransactions ]
      Layers:
      - !Ref CommonLayer

  CreateTransaction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: create-transaction/
      Handler: index.handler
      Runtime: nodejs10.x
      Events:
        ApiTrigger:
          Type: Api
          Properties:
            Path: /token/{token}/transactions
            Method: post
            RestApiId: !Ref ThankshellApi
      Policies:
        - DynamoDBReadPolicy:
            TableName: !FindInMap [ EnvironmentMap, !Ref Environment, AuthTable ]
        - DynamoDBReadPolicy:
            TableName: !FindInMap [ EnvironmentMap, !Ref Environment, UsersTable ]
        - DynamoDBReadPolicy:
            TableName: !FindInMap [ EnvironmentMap, !Ref Environment, GroupsTable ]
        - DynamoDBCrudPolicy:
            TableName: !FindInMap [ EnvironmentMap, !Ref Environment, TableInfo ]
        - DynamoDBCrudPolicy:
            TableName: !FindInMap [ EnvironmentMap, !Ref Environment, RemittanceTransactions ]
      Layers:
      - !Ref CommonLayer
