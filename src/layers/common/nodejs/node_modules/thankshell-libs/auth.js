const GroupMembersDao = require('thankshell-libs/GroupMembersDao.js');
const GroupMemberPermission = require('thankshell-libs/GroupMemberPermission.js');


exports.getAuthId = claims => {
  const identities = JSON.parse(claims.identities);

  return identities.providerName + ':' + identities.userId;
};

exports.getMemberIdAsync = async(groupId, authId) => {
  return await (new GroupMembersDao()).findMemberIdByAuthIdAsync(groupId, authId);
};

exports.isAccessableAsync = async(groupId, permissions, claims) => {
  let needPermission = GroupMemberPermission.VISITOR;
  if (permissions.includes('admins')) {
    needPermission = GroupMemberPermission.ADMIN;
  }
  if (permissions.includes('members')) {
    needPermission = GroupMemberPermission.MEMBER;
  }
  if (permissions.includes('visitor')){
    needPermission = GroupMemberPermission.VISITOR;
  }

  if (needPermission === GroupMemberPermission.VISITOR) {
    return true;
  }

  const authId = exports.getAuthId(claims);
  const member = await (new GroupMembersDao()).findMemberByAuthIdAsync(groupId, authId);

  if (!member) {
    return false;
  }

  if (needPermission <= member.permission){
    return true;
  }

  return false;
};
